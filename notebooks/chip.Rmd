---
title: "R Notebook"
output: html_notebook
---

See https://hbctraining.github.io/Intro-to-ChIPseq/lessons/12_functional_analysis.html

```{r}
BiocManager::install("ChIPseeker")
BiocManager::install("GO.db")
BiocManager::install("DO.db")
BiocManager::install("EnsDb.Hsapiens.v75")
BiocManager::install("clusterProfiler")
BiocManager::install("org.Hs.eg.db")
BiocManager::install("TxDb.Hsapiens.UCSC.hg38.knownGene")
```


```{r}
library(ChIPseeker)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(EnsDb.Hsapiens.v75)
library(clusterProfiler)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(ggplot2)
```

```{r}
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
peakfile <- "../data/raw/eclip/RPL22-ZR751_clearCLIP.pool.tag.uniq.del.CIMS.fdr10.f10.bed"
peakAnno <- annotatePeak(peakfile, tssRegion=c(-3000, 3000), TxDb=txdb)
```
```{r}
plotAnnoBar(peakAnno)
```

```{r}
plotDistToTSS(peakAnno)
```

```{r}
peakAnnoDf <- data.frame(peakAnno@anno)
peakEntrez <- peakAnnoDf$geneId
annotations_edb <- AnnotationDbi::select(EnsDb.Hsapiens.v75,
                                         keys = peakEntrez,
                                         columns = c("GENENAME"),
                                         keytype = "ENTREZID")
annotations_edb$ENTREZID <- as.character(annotations_edb$ENTREZID)
```

```{r}
ego <- enrichGO(gene = peakEntrez, 
                    keyType = "ENTREZID", 
                    OrgDb = org.Hs.eg.db, 
                    ont = "BP", 
                    pAdjustMethod = "BH", 
                    qvalueCutoff = 0.05, 
                    readable = TRUE)

pdf("../plots/go_clip_enrichment.pdf", width=6, height=4)
dotplot(ego, showCategory=10)+theme_light()
dev.off()
```

```{r}
ekegg <- enrichKEGG(gene = peakEntrez,
                 organism = 'hsa',
                 pvalueCutoff = 0.05)

dotplot(ekegg)
```

```{r}
gene_matrix <- getTagMatrix(peak = peakAnno@anno, 
                           TxDb = txdb,
                           upstream = 1000,
                           downstream = 1000, 
                           by = "gene",
                           type = "end_site",
                           nbin=250
                           )

pdf("../plots/tts_enrichment.pdf", width=5, height=3) 
plotPeakProf(gene_matrix, xlab="Gene end (5'->3')", ylab = "Peak Frequency", conf = 0.95, resample = 1000) + theme_minimal()
dev.off()
```